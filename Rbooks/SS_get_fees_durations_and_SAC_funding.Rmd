---
title: "Get program fees, durations, and SAC funding"
output: html_notebook
---
This code screen-scrapes the TEC for SAC funding and references an Excel spreadsheet for course costs (which itself uses SAC funding rates in the calculations - this could possible be streamlined to avoid manual updating of the spreadsheet).
Previously this script also screen-scraped the Careers NZ website for course fees and durations - this method has been discontinued due to issues in reconciling qualifications with subjects - it meant that only qualifications that referred to a specific subject would be considered in estimating the costs and durations for that subject (excluding, e.g., BSc for Maths students).

```{r}
library(reticulate)
```


# Commands to setup python in R notebooks

When you run the first python chunk, R will ask to install Miniconda. I would recommend that you do this.
https://docs.conda.io/en/latest/miniconda.html 
Once Minicoda is installed, open (from the start menu) 'Anaconda Powershell Prompt (R-Mini)' and run the following command
`conda activate r-reticulate`
followed by the install commands.

Run these commands on the command line to install

python -m pip install -U selenium
python -m pip install -U bs4
python -m pip install -U pandas

Required for TEC SAC FUNDING webscrap:
python -m pip install -U lxml 
python -m pip install -U xlrd


# Check what version of python is installed, this should work on any version of 3.*
```{python}
import sys
sys.version
```


# Setup
## Load libararies
```{python}
from selenium import webdriver
from bs4 import BeautifulSoup
import pandas as pd
import pickle
import re
```

# GET SAC FUNDING RATES:

This process is more robust than the Careers NZ screen-scraping becuase all the required information is on a single page, in one table.

## Start up webdriver and navigate to starting page

If it breaks at this point you might need to obtain a copy of Chrome webdriver, The error message may give you instructions to install it, you could follow them.

You can go to: https://chromedriver.chromium.org/downloads to download the webdriver. You will also need to have a somewhat up-to-date version of Chrome installed. 
You will need to either:

* include the ChromeDriver location in your PATH environment variable, or
* include the path to ChromeDriver when instantiating webdriver.Chrome (`webdriver.Chrome('/path/to/chromedriver')`)


```{python}
driver = webdriver.Chrome()
driver.get("https://www.tec.govt.nz/funding/funding-and-performance/funding/fund-finder/student-achievement-component-provision-at-level-3-and-above-on-the-nzqf-fund/sac-funding-rates/")
```


```{python}
sac_accordions = driver.find_elements_by_css_selector("div .accordion-item")
sac_accordions
filtered_ob = filter(lambda x: x.find_element_by_class_name("accordion-header").text[0:4] == '2018', sac_accordions)
filtered_ob
filtered_list = list(filtered_ob)
filtered_list
sac_html = filtered_list[0].find_element_by_tag_name("table").get_attribute('outerHTML')
sac_html
```

```{python}
sac_pd = pd.read_html(sac_html)[0]
sac_pd.head()
```


```{python}
def sift_values(row):
    if(len(row[0]) > 1):
        print("move this")
        return row.shift(1)
    else:
        return row

sac_funding2 = sac_pd[3:].apply(sift_values, axis = 1)
sac_funding2
```

```{python}
sac_funding_a = sac_funding2[sac_funding2[1].str.contains("Not valid for PTEs")].shift(-1,axis = 1)
sac_funding_a[0] = sac_funding_a[0].str.slice(0,1)
sac_funding_a
```

```{python}
sac_funding3 = sac_funding2[pd.notna(sac_funding2[0])].append(sac_funding_a)
sac_funding3.columns = ["category", "classification", "1", "2", "3", "4", "5"]
sac_funding3
```

```{python}
sac_funding_rates = sac_funding3.set_index("category").drop(columns=["classification"])
sac_funding_rates
```

```{python}
def convert_to_num(v):
    if(pd.notna(v)):
        return pd.to_numeric(v[1:].replace(",", ""))
    else:
        return v

sac_funding_rates2 = sac_funding_rates.apply(lambda x: x.apply(convert_to_num))
sac_funding_rates2
```

# Map to NZSCED

```{python}
nzsced_map1 = pd.read_excel("../program_costs/NZSCED to SAC.xls")
nzsced_map1.head()
```

```{python}
nzsced_map1[nzsced_map1['NZSCED to SAC: SAC category and level'] == '0601 Medical Studies']
# cells that were na are now NaN
```
```{python}
def get_sac_funding_rate(code, number):
    temp = sac_funding_rates2[number][code]
    if temp is None:
        return NaN
    elif isinstance(temp, float):
       return temp
    else:
        return sac_funding_rates2[number][code][0]
```


```{python}
sac_funding_rates2["3"]["H"]
get_sac_funding_rate("H", "3")
```


```{python}
def use_funding_code(x):
    if pd.isna(x):
        return x
    if len(x) == 2:
        return get_sac_funding_rate(x[0], x[1])
    elif len(x) == 4:
        x = x.split("/")
        cat = x[0][0]
        l1 = x[0][1]
        l2 = x[1]
        rate1 = get_sac_funding_rate(cat, l1)
        rate2 = get_sac_funding_rate(cat, l2)
        #print(x)
        return (rate1 + rate2) / 2
        
    elif len(x) == 5:
        x = x.split("/")
        rate1 = get_sac_funding_rate(x[0][0], x[0][1])
        rate2 = get_sac_funding_rate(x[1][0], x[1][1])
        return (rate1 + rate2) / 2
    else:
        return x

use_funding_code("A1"), use_funding_code("A3/4"), use_funding_code("A1/B2"), use_funding_code(float('NaN'))
```

```{python}
def map_nzsced_to_sac(row):
    return row.apply(use_funding_code)
nzsced_sac_rates = nzsced_map1.set_index("NZSCED to SAC: SAC category and level").apply(map_nzsced_to_sac, axis = 1)
nzsced_sac_rates.head()
```

```{python}
nzsced_sac_rates.to_csv("../program_costs/NZSCED_SAC_rates.csv")
```


# ***********************************************
# R section: get fees and durations from spreadsheet, do some filling of the gaps, then merge with SAC funding rates
# ***********************************************


```{r}
library(tidyverse)
```

# Converting updated Damien Fees spreadsheet to format of fees_and_durations spreadsheet

```{r}

damien_2018_costs <- read_excel("../program_costs/Damien Fee and Duration Tables 2018_4_DW.xlsx", 
                                                               range = "C3:I81", na = "n/a")
costs_long <- pivot_longer(damien_2018_costs, cols = c('4':'10'), names_to = 'qualLevel', values_to = 'fee')
names(costs_long)[1] <- "NZSCED_Narrow"
costs_long$fee = costs_long$fee - 5000 #Removing previous (2013) living cost + CRC amount that has been included early in the figures

damien_2018_durations <- read_excel("~/UNZ/Census work/Copy of Damien Fee and Duration Tables 2018_4_DW.xlsx", 
                                range = "J3:P81", na = "n/a")
durations_long <- pivot_longer(damien_2018_durations, cols = c('4':'10'), names_to = 'qualLevel', values_to = 'duration_yr')
names(durations_long)[1] <- "NZSCED_Narrow"

#Don't need loan at graduation data as this is calculated later (using 2018 non-fees amount)

full <- left_join(costs_long, durations_long, by = c("NZSCED_Narrow", "qualLevel"))

#full <- left_join(full, loans_at_grad_long, by = c("NZSCED_Narrow", "qualLevel"))

write.csv(full, "level_nzsced_fees_updated.csv", row.names = FALSE)

```



```{r}
fees_and_durations <- read.csv("../datasets/level_nzsced_fees_updated.csv")
head(fees_and_durations)

fees_and_durations["qualLevel"] <- formatC(fees_and_durations$qualLevel, width = 2, flag = "0")
fees_and_durations["NZSCED_Narrow"] <- formatC(fees_and_durations$NZSCED_Narrow, width = 4, flag = "0")
fees_and_durations["duration_whole_yr"] <- round(fees_and_durations$duration_yr)
head(fees_and_durations)
```


## Use sensible values to full gaps
```{r}
fees_full <- tibble(
    level_code = c('04', '05', '07', '08', '09', '10'),
    fee = c(5500, 6000, 6500, 7000, 8000, 9000),
    duration_yr = c(0.5, 1, 3, 1, 2, 3)
)
fees_full
```


### Get all the level-field combinations

This uses a dataset from the analysis process, do I want to do this?
```{r}
field_narrow <- readxl::read_excel("../metadata/NZSCED_narrow_cen.xlsx", na = "NA", skip=7) %>% filter(Code != '0000')
desired_combinations <- merge(field_narrow["Code"], fees_full["level_code"], by=NULL) %>% rename(field_code = Code)
head(desired_combinations)
```


### Use the fuller
```{r}
fees_and_durations2 <- fees_and_durations %>% rename(level_code = qualLevel, field_code = NZSCED_Narrow) %>%
    right_join(desired_combinations) %>% full_join(by='level_code', fees_full, suffix = c('_c', '_e')) %>%
    mutate(
        duration_yr = ifelse(is.na(duration_yr_c), duration_yr_e, duration_yr_c),
        fee = ifelse(is.na(fee_c), fee_e, fee_c)
    ) %>%
    select(level_code, field_code, duration_yr, fee)
head(fees_and_durations2)

```



## calculate fees for course and likely loan balance
Cumulative duration created which considers previous study for postgraduate qualifications 
NB: PhD cumulative duration = Bach + Mast + PhD
Using median non-fee component for 2018 of $6983 (Table 4, Student Loan Scheme Annual Report 2019)

```{r}
fees_and_durations2$cum_duration = fees_and_durations2$duration_yr
fees_and_durations2 = fees_and_durations2 %>% arrange(field_code, level_code)

subset1 = filter(fees_and_durations2, level_code %in% c('07', '08')) %>% group_by(field_code) %>% mutate(cum_duration = cumsum(duration_yr)) %>% filter(level_code != '07')
subset2 = filter(fees_and_durations2, !level_code %in% c('04', '05', '08')) %>% group_by(field_code) %>% mutate(cum_duration = cumsum(duration_yr))
fees2 = rbind(subset1, subset2, filter(fees_and_durations2,  level_code %in% c('04', '05')))

#Accounting for Honours quals that include Bachelors
fees2[which(fees2$level_code == '08' & fees2$duration_yr >= 4),]$cum_duration = fees2[which(fees2$level_code == '08' & fees2$duration_yr >= 4),]$duration_yr

fees2 = mutate(fees2, 
        fee_component = fee * duration_yr,
        none_fee_component = 6983 * duration_yr 
        #$4800 ~ median living costs + CRC borrowed in 2013 (6983 in 2018)
    ) %>% mutate(
        duration_whole_yr = signif(cum_duration, 1),
        loan_for_course = fee_component + none_fee_component
    )

#Checking
filter(fees2, field_code == '1007') %>% arrange(level_code) %>% View()
```


loan_at_graduation considers loan of previous study for postgrad qualifications
Need to carefully note whether Honours degrees are 1 year or 4+ years.

New method below

```{r}
fees2$loan_at_graduation = fees2$loan_for_course

fees2 = fees2 %>% arrange(field_code, level_code)

subset1 = filter(fees2, level_code %in% c('07', '08')) %>% group_by(field_code) %>% mutate(loan_at_graduation = cumsum(loan_for_course)) %>% filter(level_code != '07')

subset2 = filter(fees2, !level_code %in% c('04', '05', '08')) %>% group_by(field_code) %>% mutate(loan_at_graduation = cumsum(loan_for_course))

costs = rbind(subset1, subset2, filter(fees2,  level_code %in% c('04', '05')))

#Accounting for Honours quals that include Bachelors
costs[which(costs$level_code == '08' & costs$duration_yr >= 4),]$loan_at_graduation = costs[which(costs$level_code == '08' & costs$duration_yr >= 4),]$loan_for_course

#Checking
filter(costs, field_code == '0607') %>% arrange(level_code) %>% View()
```

```{r}
# costs <- fees2 %>% mutate(
#     loan_at_graduation = ifelse(level_code %in% c("03", "04", "05", "07"), 
#                           loan_for_course,
#                               ifelse(level_code %in% c("08", "09"), 
#                                   loan_for_course + fees2[fees2$level_code == "07" & fees2$field_code == field_code,]$loan_for_course,
#                                   #Else, Level 10 PhD
#                                   loan_for_course + 
#                                      fees2[fees2$level_code == "07" & fees2$field_code == field_code,"loan_for_course"] +
#                                      fees2[fees2$level_code == "09" & fees2$field_code == field_code,"loan_for_course"]
#                               )
#                          ),
# )
# 

```

## Merge in SAC rates
```{r}
sac_funding <- read.csv("../program_costs/NZSCED_SAC_rates.csv")
print(colnames(sac_funding))

colnames(sac_funding) <- c('field_text', 'lvl 04', 'lvl 05', 'lvl 07', 'lvl 08', 'lvl 09', 'lvl 10')
print(colnames(sac_funding))
```

```{r}
sac_funding2 <- sac_funding %>% mutate(field_code = substr(field_text, 1, 4)) %>% 
    select(-c(field_text)) %>% 
    pivot_longer(cols = -c(field_code), names_to = "level_code", names_prefix = "lvl ", values_to = "sac_funding")
tail(sac_funding2)
```

```{r}
sac_paid <- costs %>% left_join(sac_funding2, by=c("level_code", "field_code")) %>%
    mutate(
        total_funding = sac_funding * duration_yr
    )
sac_paid %>% filter(field_code == '0607') %>% head(8)
```

## Save fee, duration and funding dataset
```{r}
write.csv(sac_paid, "../program_costs/fees_durations_SAC_NEW.csv", row.names = FALSE)
```

